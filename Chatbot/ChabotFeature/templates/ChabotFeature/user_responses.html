{% extends 'base.html' %}
{% load static %}

{% block content %}
<h1>Your Responses</h1>

<table id="user-responses" class="display">
    <thead>
        <tr>
            <th>Flow Name</th>
            <th>Date and Time Created</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for response in responses %}
        <tr>
            <td>{{ response.step.flow.name }}</td>
            <td>{{ response.response_date|date:"Y-m-d H:i" }}</td>
            <td>
                <button class="review-flow-btn" data-flow-id="{{ response.step.flow.id }}" data-response-id="{{ response.id }}">Review Flow</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Modal for Flow Review -->
<div id="flowReviewModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalFlowName"></h2>
        <div id="flowSteps"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>
<script>
    $(document).ready(function() {
        $('#user-responses').DataTable();

        // Flow Review Modal
        var modal = document.getElementById("flowReviewModal");
        var span = document.getElementsByClassName("close")[0];

        $('.review-flow-btn').on('click', function() {
            var flowId = $(this).data('flow-id');
            var responseId = $(this).data('response-id');
            var flowName = $(this).closest('tr').find('td:first').text();
            
            // Set the flow name in the modal
            $('#modalFlowName').text(flowName);
            
            // AJAX call to get flow steps and user responses
            $.ajax({
                url: '{% url "get_flow_steps" %}',
                data: {
                    'flow_id': flowId,
                    'response_id': responseId
                },
                dataType: 'json',
                success: function(data) {
                    var stepsHtml = '';
                    data.steps.forEach(function(step, index) {
                        stepsHtml += '<div class="step">';
                        stepsHtml += '<h3>Step ' + (index + 1) + ': ' + step.text + '</h3>';
                        stepsHtml += '<p><strong>Your response:</strong> ' + (step.user_response || 'No response') + '</p>';
                        stepsHtml += '</div>';
                    });
                    $('#flowSteps').html(stepsHtml);
                    modal.style.display = "block";
                }
            });
        });

        span.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    });
</script>

<style>
    /* DataTable Styling */
    #user-responses {
        width: 100%;
        border-collapse: collapse;
    }

    #user-responses th, #user-responses td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    #user-responses thead {
        background-color: #f2f2f2;
    }

    /* Review Button Styling */
    .review-flow-btn {
        background-color: #4CAF50;
        border: none;
        color: white;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.3s;
    }

    .review-flow-btn:hover {
        background-color: #45a049;
    }

    /* Modal Styling */
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 5px;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .step {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 5px;
    }

    .step h3 {
        margin-top: 0;
        color: #333;
    }

    #modalFlowName {
        color: #4CAF50;
        text-align: center;
    }
</style>
{% endblock %}